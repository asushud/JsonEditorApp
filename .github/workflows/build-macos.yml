name: Build macOS app (JsonEditor)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Show Java version
        run: java -version

      # ------------------------------------------------------------
      # üß± 1. Compile Java sources
      # ------------------------------------------------------------
      - name: Compile Java files
        run: |
          rm -rf build
          mkdir -p build
          javac -cp ".:jackson-core.jar:jackson-databind.jar:jackson-annotations.jar" -d build *.java

      # ------------------------------------------------------------
      # üì¶ 2. Prepare JARs for packaging
      # ------------------------------------------------------------
      - name: Create JAR and input folder
        run: |
          mkdir -p input
          jar cfe JsonEditor.jar JsonEditor -C build .
          cp JsonEditor.jar input/
          cp jackson-core.jar jackson-databind.jar jackson-annotations.jar input/ || true

      # ------------------------------------------------------------
      # ‚öôÔ∏è 3. Create minimal runtime image (‚úÖ fixed output path)
      # ------------------------------------------------------------
      - name: Create custom runtime with jlink
        run: |
          rm -rf runtime
          $JAVA_HOME/bin/jlink \
            --module-path $JAVA_HOME/jmods \
            --add-modules java.base,java.logging,java.xml,java.desktop \
            --output runtime \
            --compress=2 \
            --no-header-files \
            --no-man-pages

      # ------------------------------------------------------------
      # üíª 4. Package macOS app
      # ------------------------------------------------------------
      - name: Build .app and .dmg with jpackage
        run: |
          rm -rf pkg-output
          mkdir -p pkg-output
          $JAVA_HOME/bin/jpackage \
            --name JsonEditor \
            --input input \
            --main-jar JsonEditor.jar \
            --main-class JsonEditor \
            --type dmg \
            --app-version 1.0 \
            --runtime-image runtime \
            --java-options "-Dapple.awt.UIElement=false" \
            --verbose \
            --dest pkg-output

      # ------------------------------------------------------------
      # üîß 5. Fix permissions and remove quarantine
      # ------------------------------------------------------------
      - name: Fix executable and remove quarantine
        run: |
          APP_PATH="pkg-output/JsonEditor.app"
          EXEC_PATH="$APP_PATH/Contents/MacOS/JsonEditor"

          chmod +x "$EXEC_PATH"
          xattr -cr "$APP_PATH"

          echo "‚úÖ Permissions fixed for $EXEC_PATH"

      # ------------------------------------------------------------
      # üóúÔ∏è 6. Zip artifacts correctly (preserve app metadata)
      # ------------------------------------------------------------
      - name: Package .app and .dmg for artifacts
        run: |
          mkdir -p artifacts
          if [ -d "pkg-output/JsonEditor.app" ]; then
            ditto -c -k --sequesterRsrc --keepParent "pkg-output/JsonEditor.app" "artifacts/JsonEditor.app.zip"
          fi
          if [ -f "pkg-output/JsonEditor-1.0.dmg" ]; then
            cp "pkg-output/JsonEditor-1.0.dmg" artifacts/
          fi
          ls -la artifacts

      # ------------------------------------------------------------
      # ‚òÅÔ∏è 7. Upload build artifacts
      # ------------------------------------------------------------
      - name: Upload build outputs
        uses: actions/upload-artifact@v4
        with:
          name: JsonEditor-macOS
          path: artifacts
