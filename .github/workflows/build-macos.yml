name: Build JsonEditor Fat Jar

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    env:
      JAVA_HOME: C:\hostedtoolcache\windows\Java_Temurin-Hotspot_jdk\21.0.8-9.0\x64

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Create build folder
      run: mkdir build

    - name: Compile Java sources
      run: javac -d build -cp ".;jackson-core.jar;jackson-databind.jar;jackson-annotations.jar" src/jsoneditor/*.java

    - name: Create fat jar folder
      run: mkdir fat-jar

    - name: Copy compiled classes to fat-jar
      run: Copy-Item build\* fat-jar\ -Recurse

    - name: Extract dependencies into fat-jar
      run: |
        $jars = "jackson-core.jar","jackson-databind.jar","jackson-annotations.jar"
        foreach ($jar in $jars) {
            Write-Host "Extracting $jar"
            $tempDir = "$env:TEMP\jartemp"
            Remove-Item -Recurse -Force $tempDir -ErrorAction SilentlyContinue
            mkdir $tempDir
            [System.IO.Compression.ZipFile]::ExtractToDirectory($jar, $tempDir)
            # Copy only .class files and flatten folder structure
            Get-ChildItem $tempDir -Recurse -Include *.class | Copy-Item -Destination fat-jar -Force
            Remove-Item -Recurse -Force $tempDir
        }

    - name: Build final fat jar
      run: |
        cd fat-jar
        jar cfe ../JsonEditor-fat.jar jsoneditor.JsonEditor *
        cd ..

    - name: List fat jar contents
      run: jar tf JsonEditor-fat.jar

    - name: Test running fat jar
      run: java -jar JsonEditor-fat.jar
