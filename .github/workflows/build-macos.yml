name: Build JsonEditor Fat Jar

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Java 21
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 21

      - name: Build Fat Jar
        shell: pwsh
        run: |
          $buildDir = "build"
          $fatJarDir = "fat-jar"
          $tempDir = "$env:TEMP\jartemp"

          # Clean old folders
          Remove-Item -Recurse -Force $buildDir,$fatJarDir -ErrorAction SilentlyContinue
          mkdir $buildDir
          mkdir $fatJarDir

          # Compile Java sources
          $sourceFile = "jsoneditor/JsonEditor.java"
          $classpath = ".;jsoneditor/jackson-core.jar;jsoneditor/jackson-databind.jar;jsoneditor/jackson-annotations.jar"
          javac -d $buildDir -cp $classpath $sourceFile

          # Copy compiled classes to fat-jar folder
          Copy-Item "$buildDir/*" $fatJarDir -Recurse

          # Extract Jackson dependencies into fat-jar folder (skip META-INF)
          foreach ($jar in "jsoneditor/jackson-core.jar","jsoneditor/jackson-databind.jar","jsoneditor/jackson-annotations.jar") {
              Write-Host "Extracting $jar"
              Remove-Item -Recurse -Force $tempDir -ErrorAction SilentlyContinue
              mkdir $tempDir
              [System.IO.Compression.ZipFile]::ExtractToDirectory($jar, $tempDir)
              Get-ChildItem $tempDir -Recurse | Where-Object { $_.PSIsContainer -eq $false -and $_.FullName -notmatch "META-INF" } |
                  Copy-Item -Destination $fatJarDir -Force
              Remove-Item -Recurse -Force $tempDir
          }

          # Create final fat jar with main class
          cd $fatJarDir
          jar cfe ../JsonEditor-fat.jar jsoneditor.JsonEditor *
          cd ..
          Write-Host "Fat jar created: JsonEditor-fat.jar"

      - name: List files
        run: dir

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: JsonEditor-fat-jar
          path: JsonEditor-fat.jar
