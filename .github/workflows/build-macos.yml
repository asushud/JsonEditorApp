name: Build macOS app (jlink + jpackage with console)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Show Java version
        run: java -version

      # ------------------------------------------------------------
      # üß± 1. Compile all Java sources
      # ------------------------------------------------------------
      - name: Compile Java files
        run: |
          rm -rf build
          mkdir -p build
          javac -cp ".:jackson-core.jar:jackson-databind.jar:jackson-annotations.jar" -d build *.java

      # ------------------------------------------------------------
      # üì¶ 2. Create main jar & input folder
      # ------------------------------------------------------------
      - name: Create main JAR and prepare input folder
        run: |
          mkdir -p input
          jar cfe JsonEditor.jar JsonEditor -C build .
          cp JsonEditor.jar input/
          cp jackson-core.jar jackson-databind.jar jackson-annotations.jar input/ || true

      # ------------------------------------------------------------
      # ‚öôÔ∏è 3. Create minimal runtime
      # ------------------------------------------------------------
      - name: Create custom runtime image with jlink
        run: |
          rm -rf custom-jre
          $JAVA_HOME/bin/jlink \
            --module-path $JAVA_HOME/jmods \
            --add-modules java.base,java.logging,java.xml,java.desktop \
            --output custom-jre \
            --compress=2 \
            --no-header-files \
            --no-man-pages

      # ------------------------------------------------------------
      # üíª 4. Package app (console mode)
      # ------------------------------------------------------------
      - name: Run jpackage to create .dmg and .app (console visible)
        run: |
          rm -rf pkg-output
          mkdir -p pkg-output
          $JAVA_HOME/bin/jpackage \
            --name JsonEditor \
            --input input \
            --main-jar JsonEditor.jar \
            --main-class JsonEditor \
            --type app-image \
            --runtime-image custom-jre \
            --java-options "-Dapple.awt.UIElement=false" \
            --dest pkg-output \
            --verbose

          echo "‚úÖ App image created. Converting to DMG..."
          $JAVA_HOME/bin/jpackage \
            --name JsonEditor \
            --app-image pkg-output/JsonEditor.app \
            --type dmg \
            --dest pkg-output \
            --verbose

      # ------------------------------------------------------------
      # üîß 5. Ensure permissions and executable bit
      # ------------------------------------------------------------
      - name: Fix permissions inside .app bundle
        run: |
          APP_PATH="pkg-output/JsonEditor.app"
          EXEC_PATH="$APP_PATH/Contents/MacOS/JsonEditor"
          if [ -f "$EXEC_PATH" ]; then
            chmod +x "$EXEC_PATH"
            echo "Executable bit fixed for: $EXEC_PATH"
          fi

      # ------------------------------------------------------------
      # üóúÔ∏è 6. Zip artifacts safely
      # ------------------------------------------------------------
      - name: Zip app and dmg for artifacts
        run: |
          mkdir -p artifacts
          if [ -d "pkg-output/JsonEditor.app" ]; then
            ditto -c -k --sequesterRsrc --keepParent "pkg-output/JsonEditor.app" "artifacts/JsonEditor.app.zip"
          fi
          if [ -f "pkg-output/JsonEditor-1.0.dmg" ]; then
            cp "pkg-output/JsonEditor-1.0.dmg" artifacts/
          fi
          ls -la artifacts

      # ------------------------------------------------------------
      # ‚òÅÔ∏è 7. Upload artifacts
      # ------------------------------------------------------------
      - name: Upload build outputs
        uses: actions/upload-artifact@v4
        with:
          name: JsonEditor-macOS
          path: artifacts
