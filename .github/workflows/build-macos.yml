name: Build JsonEditor Fat Jar

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      - name: Create build directories
        run: |
          mkdir -Force jsoneditor\build
          mkdir -Force jsoneditor\jartemp

      - name: Compile Java code
        run: |
          javac -d jsoneditor\build -cp "jsoneditor\jackson-core.jar;jsoneditor\jackson-databind.jar;jsoneditor\jackson-annotations.jar" jsoneditor\JsonEditor.java

      - name: Extract Jackson jars
        run: |
          powershell -Command "
            foreach ($jar in @('jackson-core.jar','jackson-databind.jar','jackson-annotations.jar')) {
              [System.IO.Compression.ZipFile]::ExtractToDirectory('jsoneditor\\' + $jar, 'jsoneditor\\jartemp')
            }
          "

      - name: Copy compiled classes to temp
        run: |
          xcopy jsoneditor\build\* jsoneditor\jartemp /E /I /Y

      - name: Build fat jar
        run: |
          cd jsoneditor\jartemp
          jar cfe ..\JsonEditor-fat.jar jsoneditor.JsonEditor *
          cd ../..

      - name: Upload fat jar artifact
        uses: actions/upload-artifact@v3
        with:
          name: JsonEditor-fat-jar
          path: jsoneditor\JsonEditor-fat.jar
