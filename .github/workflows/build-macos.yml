name: Build macOS app (JsonEditor fixed)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Show Java version
        run: java -version

      # 1️⃣ Compile sources
      - name: Compile Java files
        run: |
          rm -rf build
          mkdir -p build
          javac -cp ".:jackson-core.jar:jackson-databind.jar:jackson-annotations.jar" -d build *.java

      # 2️⃣ Create JAR and input folder
      - name: Create JAR and prepare input folder
        run: |
          mkdir -p input
          jar cfe JsonEditor.jar JsonEditor -C build .
          cp JsonEditor.jar input/
          cp jackson-core.jar jackson-databind.jar jackson-annotations.jar input/ || true

      # 3️⃣ Create runtime
      - name: Create custom runtime image
        run: |
          rm -rf runtime
          $JAVA_HOME/bin/jlink \
            --module-path $JAVA_HOME/jmods \
            --add-modules java.base,java.logging,java.xml,java.desktop \
            --output runtime \
            --compress=2 \
            --no-header-files \
            --no-man-pages

      # 4️⃣ Create .app first (✅ now exists in pkg-output/)
      - name: Create .app image with jpackage
        run: |
          rm -rf pkg-output
          mkdir -p pkg-output
          $JAVA_HOME/bin/jpackage \
            --type app-image \
            --name JsonEditor \
            --input input \
            --main-jar JsonEditor.jar \
            --main-class JsonEditor \
            --runtime-image runtime \
            --java-options "-Dapple.awt.UIElement=false" \
            --dest pkg-output \
            --verbose

      # 5️⃣ Fix permissions & quarantine
      - name: Fix permissions inside .app
        run: |
          APP_PATH="pkg-output/JsonEditor.app"
          EXEC_PATH="$APP_PATH/Contents/MacOS/JsonEditor"
          if [ -f "$EXEC_PATH" ]; then
            chmod +x "$EXEC_PATH"
            xattr -cr "$APP_PATH"
            echo "✅ Permissions fixed for $EXEC_PATH"
          else
            echo "⚠️ Executable not found at $EXEC_PATH"
            echo "Directory contents:"
            ls -R pkg-output
            exit 1
          fi

      # 6️⃣ Wrap .app into .dmg
      - name: Create .dmg from .app
        run: |
          $JAVA_HOME/bin/jpackage \
            --type dmg \
            --name JsonEditor \
            --app-image pkg-output/JsonEditor.app \
            --dest pkg-output \
            --verbose

      # 7️⃣ Zip artifacts safely
      - name: Zip app and dmg
        run: |
          mkdir -p artifacts
          ditto -c -k --sequesterRsrc --keepParent "pkg-output/JsonEditor.app" "artifacts/JsonEditor.app.zip"
          cp pkg-output/JsonEditor-1.0.dmg artifacts/ || true
          ls -la artifacts

      # 8️⃣ Upload build artifacts
      - name: Upload build outputs
        uses: actions/upload-artifact@v4
        with:
          name: JsonEditor-macOS
          path: artifacts
