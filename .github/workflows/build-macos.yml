name: Build macOS Native Image (.app)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup GraalVM 17
        uses: graalvm/setup-graalvm@v1
        with:
          java-version: '17'
          distribution: 'graalvm-community'
          components: 'native-image'

      - name: Build JAR
        run: |
          javac -cp ".:jackson-core.jar:jackson-databind.jar:jackson-annotations.jar" JsonEditor.java
          jar cfe JsonEditor-fat.jar JsonEditor *.class

      - name: Build Native Image
        run: |
          native-image \
            -H:Name=JsonEditor \
            -H:ReflectionConfigurationFiles=reflect-config.json \
            -cp "JsonEditor-fat.jar:jackson-core.jar:jackson-databind.jar:jackson-annotations.jar" \
            JsonEditor
          mkdir -p dist/JsonEditor.app/Contents/MacOS
          mv JsonEditor dist/JsonEditor.app/Contents/MacOS/

      - name: Create Info.plist
        run: |
          mkdir -p dist/JsonEditor.app/Contents
          cat > dist/JsonEditor.app/Contents/Info.plist <<'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleName</key><string>JsonEditor</string>
            <key>CFBundleDisplayName</key><string>JsonEditor</string>
            <key>CFBundleIdentifier</key><string>com.example.jsoneditor</string>
            <key>CFBundleVersion</key><string>1.0</string>
            <key>CFBundlePackageType</key><string>APPL</string>
            <key>CFBundleExecutable</key><string>JsonEditor</string>
          </dict>
          </plist>
          EOF

      - name: Zip .app for release
        run: |
          cd dist
          zip -r JsonEditor-macos.zip JsonEditor.app

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: JsonEditor-macos
          path: dist/JsonEditor-macos.zip
